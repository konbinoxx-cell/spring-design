import React, { useState } from 'react';
import { Calculator, Info } from 'lucide-react';

export default function CompressionSpringDesigner() {
  const [inputs, setInputs] = useState({
    maxLoad: 100, // 最大工作载荷 N
    minLoad: 20, // 最小工作载荷 N
    workingStroke: 20, // 工作行程 mm
    outerDiameter: 30, // 外径限制 mm
    freeLength: 80, // 自由长度 mm
    material: 'SWC', // 材料
    wireDiameter: 3, // 线径 mm
  });

  const [results, setResults] = useState(null);

  const materials = {
    'SWC': { name: '碳素弹簧钢丝', G: 78500, allowableStress: 800, E: 206000 },
    'SWP': { name: '钢琴钢丝', G: 78500, allowableStress: 900, E: 206000 },
    'SUS304': { name: '不锈钢丝', G: 69000, allowableStress: 600, E: 193000 },
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setInputs(prev => ({
      ...prev,
      [name]: name === 'material' ? value : parseFloat(value) || 0
    }));
  };

  const calculate = () => {
    const { maxLoad, minLoad, workingStroke, outerDiameter, freeLength, material, wireDiameter } = inputs;
    const mat = materials[material];
    
    // 中径计算
    const meanDiameter = outerDiameter - wireDiameter;
    
    // 弹簧刚度
    const springRate = (maxLoad - minLoad) / workingStroke;
    
    // 有效圈数计算
    const G = mat.G; // 剪切模量 MPa
    const effectiveCoils = (G * Math.pow(wireDiameter, 4)) / (8 * Math.pow(meanDiameter, 3) * springRate);
    
    // 总圈数（加支撑圈）
    const totalCoils = effectiveCoils + 2;
    
    // 节距
    const pitch = (freeLength - 2 * wireDiameter) / effectiveCoils;
    
    // 最大压并长度
    const solidLength = wireDiameter * totalCoils;
    
    // 旋绕比
    const springIndex = meanDiameter / wireDiameter;
    
    // 曲度系数（Wahl系数）
    const K = (4 * springIndex - 1) / (4 * springIndex - 4) + 0.615 / springIndex;
    
    // 最大切应力
    const maxShearStress = K * (8 * maxLoad * meanDiameter) / (Math.PI * Math.pow(wireDiameter, 3));
    
    // 最大工作长度
    const maxWorkingLength = freeLength - (maxLoad / springRate);
    
    // 最小工作长度
    const minWorkingLength = freeLength - ((maxLoad - minLoad + minLoad) / springRate);
    
    // 压并载荷
    const solidLoad = springRate * (freeLength - solidLength);
    
    // 安全系数
    const safetyFactor = mat.allowableStress / maxShearStress;
    
    // 稳定性校核
    const slendernessRatio = freeLength / meanDiameter;
    const criticalSlenderness = 2.6; // 临界细长比
    const stabilityStatus = slendernessRatio > criticalSlenderness ? '需要导向' : '稳定';
    
    setResults({
      meanDiameter: meanDiameter.toFixed(2),
      springRate: springRate.toFixed(2),
      effectiveCoils: effectiveCoils.toFixed(1),
      totalCoils: totalCoils.toFixed(1),
      pitch: pitch.toFixed(2),
      solidLength: solidLength.toFixed(2),
      springIndex: springIndex.toFixed(2),
      K: K.toFixed(3),
      maxShearStress: maxShearStress.toFixed(1),
      maxWorkingLength: maxWorkingLength.toFixed(2),
      minWorkingLength: minWorkingLength.toFixed(2),
      solidLoad: solidLoad.toFixed(1),
      safetyFactor: safetyFactor.toFixed(2),
      slendernessRatio: slendernessRatio.toFixed(2),
      stabilityStatus,
      isValid: safetyFactor > 1.2 && springIndex >= 4 && springIndex <= 16
    });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
          <div className="flex items-center gap-3 mb-6">
            <Calculator className="w-8 h-8 text-indigo-600" />
            <h1 className="text-3xl font-bold text-gray-800">压缩弹簧设计计算器</h1>
          </div>

          <div className="grid md:grid-cols-2 gap-6 mb-6">
            <div>
              <h2 className="text-xl font-semibold text-gray-700 mb-4">输入参数</h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    最大工作载荷 F₂ (N)
                  </label>
                  <input
                    type="number"
                    name="maxLoad"
                    value={inputs.maxLoad}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    最小工作载荷 F₁ (N)
                  </label>
                  <input
                    type="number"
                    name="minLoad"
                    value={inputs.minLoad}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    工作行程 h (mm)
                  </label>
                  <input
                    type="number"
                    name="workingStroke"
                    value={inputs.workingStroke}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    外径 D₂ (mm)
                  </label>
                  <input
                    type="number"
                    name="outerDiameter"
                    value={inputs.outerDiameter}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>
              </div>
            </div>

            <div>
              <h2 className="text-xl font-semibold text-gray-700 mb-4">设计参数</h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    自由长度 H₀ (mm)
                  </label>
                  <input
                    type="number"
                    name="freeLength"
                    value={inputs.freeLength}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    线径 d (mm)
                  </label>
                  <input
                    type="number"
                    name="wireDiameter"
                    value={inputs.wireDiameter}
                    onChange={handleInputChange}
                    step="0.1"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    材料
                  </label>
                  <select
                    name="material"
                    value={inputs.material}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  >
                    {Object.entries(materials).map(([key, mat]) => (
                      <option key={key} value={key}>{mat.name}</option>
                    ))}
                  </select>
                </div>

                <button
                  onClick={calculate}
                  className="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors font-medium mt-4"
                >
                  计算设计结果
                </button>
              </div>
            </div>
          </div>

          {results && (
            <div className="border-t pt-6">
              <h2 className="text-xl font-semibold text-gray-700 mb-4">计算结果</h2>
              
              {/* 弹簧设计图 */}
              <div className="mb-6 bg-gray-50 p-6 rounded-lg">
                <h3 className="font-semibold text-gray-700 mb-4">弹簧设计图</h3>
                <svg viewBox="0 0 800 600" className="w-full max-w-3xl mx-auto">
                  {/* 背景 */}
                  <rect width="800" height="600" fill="#ffffff"/>
                  
                  {/* 标题 */}
                  <text x="400" y="30" textAnchor="middle" fontSize="20" fontWeight="bold" fill="#374151">
                    压缩弹簧 - 技术图纸
                  </text>
                  
                  {/* 弹簧可视化 */}
                  <g transform="translate(250, 100)">
                    {/* 中心线 */}
                    <line x1="0" y1="0" x2="0" y2="400" stroke="#94a3b8" strokeWidth="1" strokeDasharray="5,5"/>
                    
                    {/* 弹簧线圈 */}
                    {(() => {
                      const totalCoils = Math.ceil(parseFloat(results.totalCoils));
                      const meanDiameter = parseFloat(results.meanDiameter);
                      return Array.from({length: totalCoils}).map((_, i) => {
                        const y = i * 40 + 20;
                        const coilWidth = meanDiameter * 1.5;
                        return (
                          <g key={i}>
                            <ellipse cx="-30" cy={y} rx={coilWidth/2} ry="8" fill="none" stroke="#3b82f6" strokeWidth="3"/>
                            <ellipse cx="30" cy={y + 20} rx={coilWidth/2} ry="8" fill="none" stroke="#3b82f6" strokeWidth="3"/>
                          </g>
                        );
                      });
                    })()}
                    
                    {/* 端部线圈（实心） */}
                    {(() => {
                      const meanDiameter = parseFloat(results.meanDiameter);
                      const totalCoils = parseFloat(results.totalCoils);
                      return (
                        <>
                          <ellipse cx="0" cy="10" rx={meanDiameter * 0.75} ry="6" fill="#3b82f6" stroke="#3b82f6" strokeWidth="2"/>
                          <ellipse cx="0" cy={totalCoils * 40} rx={meanDiameter * 0.75} ry="6" fill="#3b82f6" stroke="#3b82f6" strokeWidth="2"/>
                        </>
                      );
                    })()}
                    
                    {/* 尺寸标注 - 自由长度 */}
                    {(() => {
                      const totalCoils = parseFloat(results.totalCoils);
                      const freeLength = inputs.freeLength;
                      return (
                        <>
                          <line x1="-100" y1="10" x2="-100" y2={totalCoils * 40} stroke="#ef4444" strokeWidth="2"/>
                          <line x1="-105" y1="10" x2="-95" y2="10" stroke="#ef4444" strokeWidth="2"/>
                          <line x1="-105" y1={totalCoils * 40} x2="-95" y2={totalCoils * 40} stroke="#ef4444" strokeWidth="2"/>
                          <text x="-130" y={totalCoils * 20 + 5} fontSize="14" fill="#ef4444" fontWeight="bold">H₀={freeLength}mm</text>
                        </>
                      );
                    })()}
                    
                    {/* 尺寸标注 - 线径 */}
                    {(() => {
                      const meanDiameter = parseFloat(results.meanDiameter);
                      const wireDiameter = inputs.wireDiameter;
                      return (
                        <>
                          <line x1="0" y1="-30" x2={meanDiameter * 0.75} y2="-30" stroke="#10b981" strokeWidth="2"/>
                          <line x1="0" y1="-35" x2="0" y2="-25" stroke="#10b981" strokeWidth="2"/>
                          <line x1={meanDiameter * 0.75} y1="-35" x2={meanDiameter * 0.75} y2="-25" stroke="#10b981" strokeWidth="2"/>
                          <text x={meanDiameter * 0.4} y="-40" fontSize="14" fill="#10b981" fontWeight="bold" textAnchor="middle">d={wireDiameter}mm</text>
                        </>
                      );
                    })()}
                    
                    {/* 尺寸标注 - 中径 */}
                    {(() => {
                      const meanDiameter = parseFloat(results.meanDiameter);
                      const totalCoils = parseFloat(results.totalCoils);
                      return (
                        <>
                          <line x1={-meanDiameter * 0.75} y1={totalCoils * 40 + 30} x2={meanDiameter * 0.75} y2={totalCoils * 40 + 30} stroke="#8b5cf6" strokeWidth="2"/>
                          <line x1={-meanDiameter * 0.75} y1={totalCoils * 40 + 25} x2={-meanDiameter * 0.75} y2={totalCoils * 40 + 35} stroke="#8b5cf6" strokeWidth="2"/>
                          <line x1={meanDiameter * 0.75} y1={totalCoils * 40 + 25} x2={meanDiameter * 0.75} y2={totalCoils * 40 + 35} stroke="#8b5cf6" strokeWidth="2"/>
                          <text x="0" y={totalCoils * 40 + 50} fontSize="14" fill="#8b5cf6" fontWeight="bold" textAnchor="middle">D={results.meanDiameter}mm</text>
                        </>
                      );
                    })()}
                    
                    {/* 节距标注 */}
                    <line x1="80" y1="60" x2="80" y2="100" stroke="#f59e0b" strokeWidth="2" strokeDasharray="3,3"/>
                    <line x1="75" y1="60" x2="85" y2="60" stroke="#f59e0b" strokeWidth="2"/>
                    <line x1="75" y1="100" x2="85" y2="100" stroke="#f59e0b" strokeWidth="2"/>
                    <text x="90" y="85" fontSize="14" fill="#f59e0b" fontWeight="bold">t={results.pitch}mm</text>
                  </g>
                  
                  {/* 信息框 */}
                  <g transform="translate(550, 100)">
                    <rect width="220" height="280" fill="#f9fafb" stroke="#d1d5db" strokeWidth="2" rx="8"/>
                    <text x="110" y="30" textAnchor="middle" fontSize="16" fontWeight="bold" fill="#374151">关键参数</text>
                    
                    <text x="20" y="60" fontSize="13" fill="#4b5563">材料：</text>
                    <text x="200" y="60" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">{materials[inputs.material].name}</text>
                    
                    <text x="20" y="85" fontSize="13" fill="#4b5563">总圈数：</text>
                    <text x="200" y="85" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">{results.totalCoils}</text>
                    
                    <text x="20" y="110" fontSize="13" fill="#4b5563">弹簧刚度：</text>
                    <text x="200" y="110" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">{results.springRate} N/mm</text>
                    
                    <text x="20" y="135" fontSize="13" fill="#4b5563">旋绕比：</text>
                    <text x="200" y="135" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">{results.springIndex}</text>
                    
                    <text x="20" y="160" fontSize="13" fill="#4b5563">最大应力：</text>
                    <text x="200" y="160" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">{results.maxShearStress} MPa</text>
                    
                    <text x="20" y="185" fontSize="13" fill="#4b5563">安全系数：</text>
                    <text x="200" y="185" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">{results.safetyFactor}</text>
                    
                    <text x="20" y="210" fontSize="13" fill="#4b5563">压并长度：</text>
                    <text x="200" y="210" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">{results.solidLength} mm</text>
                    
                    <text x="20" y="235" fontSize="13" fill="#4b5563">稳定性：</text>
                    <text x="200" y="235" textAnchor="end" fontSize="13" fontWeight="bold" fill="#1f2937">{results.stabilityStatus}</text>
                    
                    <rect x="10" y="245" width="200" height="25" fill={results.isValid ? '#d1fae5' : '#fef3c7'} stroke={results.isValid ? '#10b981' : '#f59e0b'} strokeWidth="2" rx="4"/>
                    <text x="110" y="262" textAnchor="middle" fontSize="13" fontWeight="bold" fill={results.isValid ? '#065f46' : '#92400e'}>
                      {results.isValid ? '✓ 设计合理' : '⚠ 需调整参数'}
                    </text>
                  </g>
                  
                  {/* 图例 */}
                  <g transform="translate(50, 520)">
                    <text x="0" y="0" fontSize="14" fontWeight="bold" fill="#374151">尺寸说明：</text>
                    <line x1="0" y1="15" x2="30" y2="15" stroke="#ef4444" strokeWidth="2"/>
                    <text x="40" y="20" fontSize="12" fill="#6b7280">自由长度 (H₀)</text>
                    
                    <line x1="150" y1="15" x2="180" y2="15" stroke="#10b981" strokeWidth="2"/>
                    <text x="190" y="20" fontSize="12" fill="#6b7280">线径 (d)</text>
                    
                    <line x1="280" y1="15" x2="310" y2="15" stroke="#8b5cf6" strokeWidth="2"/>
                    <text x="320" y="20" fontSize="12" fill="#6b7280">中径 (D)</text>
                    
                    <line x1="410" y1="15" x2="440" y2="15" stroke="#f59e0b" strokeWidth="2" strokeDasharray="3,3"/>
                    <text x="450" y="20" fontSize="12" fill="#6b7280">节距 (t)</text>
                  </g>
                </svg>
              </div>
              
              <div className={`p-4 rounded-lg mb-4 ${results.isValid ? 'bg-green-50 border border-green-200' : 'bg-yellow-50 border border-yellow-200'}`}>
                <div className="flex items-start gap-2">
                  <Info className={`w-5 h-5 mt-0.5 ${results.isValid ? 'text-green-600' : 'text-yellow-600'}`} />
                  <div>
                    <p className={`font-medium ${results.isValid ? 'text-green-800' : 'text-yellow-800'}`}>
                      {results.isValid ? '✓ 设计合理' : '⚠ 需要调整参数'}
                    </p>
                    {!results.isValid && (
                      <p className="text-sm text-yellow-700 mt-1">
                        建议：{parseFloat(results.safetyFactor) < 1.2 ? '增大线径或减小载荷；' : ''}
                        {parseFloat(results.springIndex) < 4 ? '增大中径或减小线径；' : ''}
                        {parseFloat(results.springIndex) > 16 ? '减小中径或增大线径' : ''}
                      </p>
                    )}
                  </div>
                </div>
              </div>

              <div className="grid md:grid-cols-3 gap-4">
                <div className="bg-blue-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">中径 D</p>
                  <p className="text-2xl font-bold text-blue-700">{results.meanDiameter} mm</p>
                </div>

                <div className="bg-blue-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">弹簧刚度 k</p>
                  <p className="text-2xl font-bold text-blue-700">{results.springRate} N/mm</p>
                </div>

                <div className="bg-blue-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">有效圈数 n</p>
                  <p className="text-2xl font-bold text-blue-700">{results.effectiveCoils}</p>
                </div>

                <div className="bg-purple-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">总圈数 n₁</p>
                  <p className="text-2xl font-bold text-purple-700">{results.totalCoils}</p>
                </div>

                <div className="bg-purple-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">节距 t</p>
                  <p className="text-2xl font-bold text-purple-700">{results.pitch} mm</p>
                </div>

                <div className="bg-purple-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">压并长度 H₃</p>
                  <p className="text-2xl font-bold text-purple-700">{results.solidLength} mm</p>
                </div>

                <div className="bg-green-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">旋绕比 C</p>
                  <p className="text-2xl font-bold text-green-700">{results.springIndex}</p>
                </div>

                <div className="bg-green-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">最大切应力 τ</p>
                  <p className="text-2xl font-bold text-green-700">{results.maxShearStress} MPa</p>
                </div>

                <div className="bg-green-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">安全系数</p>
                  <p className="text-2xl font-bold text-green-700">{results.safetyFactor}</p>
                </div>

                <div className="bg-indigo-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">最大工作长度</p>
                  <p className="text-2xl font-bold text-indigo-700">{results.maxWorkingLength} mm</p>
                </div>

                <div className="bg-indigo-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">压并载荷</p>
                  <p className="text-2xl font-bold text-indigo-700">{results.solidLoad} N</p>
                </div>

                <div className="bg-indigo-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">稳定性</p>
                  <p className="text-2xl font-bold text-indigo-700">{results.stabilityStatus}</p>
                </div>
              </div>

              <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                <h3 className="font-semibold text-gray-700 mb-2">设计建议</h3>
                <ul className="text-sm text-gray-600 space-y-1">
                  <li>• 旋绕比 C 应在 4-16 之间（当前: {results.springIndex}）</li>
                  <li>• 安全系数应大于 1.2（当前: {results.safetyFactor}）</li>
                  <li>• 细长比 = {results.slendernessRatio}，{results.stabilityStatus}</li>
                  <li>• 压并时应留有安全裕度，建议压并载荷不超过最大工作载荷的 1.25 倍</li>
                </ul>
              </div>
            </div>
          )}
        </div>

        <div className="bg-white rounded-2xl shadow-xl p-6">
          <h2 className="text-lg font-semibold text-gray-700 mb-3">设计说明</h2>
          <div className="text-sm text-gray-600 space-y-2">
            <p><strong>基本公式：</strong></p>
            <p>• 弹簧刚度: k = (F₂ - F₁) / h</p>
            <p>• 有效圈数: n = Gd⁴ / (8D³k)</p>
            <p>• 切应力: τ = K × 8FD / (πd³)</p>
            <p>• 旋绕比: C = D / d</p>
            <p className="pt-2"><strong>设计原则：</strong>旋绕比 C 在 4-16 之间，安全系数 &gt; 1.2，需考虑压并高度和稳定性</p>
          </div>
        </div>
      </div>
    </div>
  );
}
